#!/usr/local/bin/perl
## download a RC page, extract Perl 5 entry
#c# 2018-03-30

use utf8;

use Modern::Perl;

my $w = shift || die;
$w =~ s#^.*wiki/##;
$w =~ s/#.*//;

(my $f = $w) =~ s#/#_#g;
$f =~ s#'#_#g;
$f =~ s#\$#_#g;
$f .= '.pl';

if (-e "$f") {
for my $i (reverse 1..8) {
    my $j = $i + 1;
    system "mv $f.$i $f.$j" if -e "$f.$i";
}
system "mv $f $f.1" 
}

$w =~ s/'/\\'/g;

my $perl5 = `curl -s -o - 'http://rosettacode.org/wiki/$w' | tee _download.html | perl -0 -npe 's/^.*id="Perl".(.*?)<h2>.*/\$1/s; s/&#160;/ /sg;s#<br */>#<br/>\\n#sg' | strip-html - `;
die "No text!" if $perl5 =~ /currently no text/i;

$perl5 =~ s/^Perl\s*\[edit\]//;
$perl5 =~ s/Works with/# Works with/ms;
$perl5 =~ s/\xA0//g;
$perl5 =~ s/PerlÃ‚/Perl /g;

my $ymd = `date +%Y-%m-%d`; chomp $ymd;
my $ym  = `date +%Y.%m`; chomp $ym;

open F, ">$f";
print F <<EOP;
#!/usr/local/bin/perl
#u# http://rosettacode.org/wiki/$w
#c# $ymd <RC
#5# Perl 5 code, NOT Perl 6!

$perl5

use Test::More;
#is (\$result, \$ref);
#done_testing();
EOP

system "chmod +x $f";
