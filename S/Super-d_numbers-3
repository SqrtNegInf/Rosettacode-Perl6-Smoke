#!/usr/bin/env perl6
#u# http://rosettacode.org/wiki/Super-d_numbers
#c# 2019-10-xx NOT ON RC
#n# divide and conquer, but how to exit early? (i.e. not have fixed termination value)
#n# $inc, $over are tunable parameters, scale with $d

# 7: 119.011u  2.402s  2:18.58  87.6% no concur.
# 7:  86.718u  3.277s  0:33.13 271.5%

# 8:2246.582u 46.147s 50:03.70  76.3% no concur.
# 8: 856.339u 25.286s  5:04.94 289.1%

# 9:6086.10u  201.76s 41:52.46 250.2%

my @res;

sub super-d ($d,$max) {
my $over = $max + floor 2*$max/$d;
my @super[$over] = 0 xx $over;
{
my $digits = $d x $d;
my $inc    = 25 * $max * $d;
my atomicint $i = 0;
(0, 1*$inc, 2*$inc ... *).race(:1batch).map: -> $n {
    for $n+1 .. $n+1+$inc {
        next unless ($_ ** $d  *  $d).contains($digits);
        @super[$iâš›++] = $_;
        X::AdHoc.new.throw if $i >= $over;
    }
  }
    CATCH { when X::AdHoc { } }
}
@super.sort.grep(*>0).head($max);
}

@res.push: "$_: " ~ join ' ', super-d($_,10) for 2..6;

.say for @res;

my $ref = q:to/END/;
2: 19 31 69 81 105 106 107 119 127 131
3: 261 462 471 481 558 753 1036 1046 1471 1645
4: 1168 4972 7423 7752 8431 10267 11317 11487 11549 11680
5: 4602 5517 7539 12955 14555 20137 20379 26629 32767 35689
6: 27257 272570 302693 323576 364509 502785 513675 537771 676657 678146
END
#7: 140997 490996 1184321 1259609 1409970 1783166 1886654 1977538 2457756 2714763
#8: 185423 641519 1551728 1854230 6415190 12043464 12147605 15517280 16561735 18542300

use Test;
is @res.join("\n"), chomp $ref;
