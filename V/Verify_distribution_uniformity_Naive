#!/usr/bin/env perl6
#u# http://rosettacode.org/wiki/Verify_distribution_uniformity/Naive
#c# 2016-06-12 <RC
#m# MOAR: OK
#j#  JVM: OK
#n# 2020-10-07 different answers when run from interactive shell vs cron-launch?

srand 123456;

# Since the tested function is rolls of a 7 sided die, the test numbers are magnitudes of 10x bumped up to the closest multiple of 7. This reduces spurious error from there not being an integer expected value.

my $d7 = 1..7;
sub roll7 { $d7.roll };

my $threshold = 3;

for 14, 105, 1001, 10003, 100002, 1000006 ->  $n
  { dist( $n, $threshold,  &roll7 ) };


my @res;
sub dist ( $n is copy, $threshold, &producer ) {
    my @dist;
    my $expect = $n / 7;
    @res.push: sprintf "Expect\t%.3f", $expect;

    loop ($_ = $n; $n; --$n) { @dist[&producer()]++; }

    for @dist.kv -> $i, $v is copy {
        next unless $i;
        $v //= 0;
        my $pct = ($v - $expect)/$expectÃ—100;
        @res.push: sprintf "%d\t%d\t%+.2f%% %s", $i, $v, $pct,
          ($pct.abs > $threshold ?? '- skewed' !! '');
    }
}

.say for @res;

my $moar = qq:to/END/;
Expect	2.000
1	2	+0.00% 
2	2	+0.00% 
3	1	-50.00% - skewed
4	1	-50.00% - skewed
5	2	+0.00% 
6	2	+0.00% 
7	4	+100.00% - skewed
Expect	15.000
1	13	-13.33% - skewed
2	17	+13.33% - skewed
3	12	-20.00% - skewed
4	16	+6.67% - skewed
5	15	+0.00% 
6	13	-13.33% - skewed
7	19	+26.67% - skewed
Expect	143.000
1	151	+5.59% - skewed
2	157	+9.79% - skewed
3	125	-12.59% - skewed
4	148	+3.50% - skewed
5	136	-4.90% - skewed
6	132	-7.69% - skewed
7	152	+6.29% - skewed
Expect	1429.000
1	1524	+6.65% - skewed
2	1502	+5.11% - skewed
3	1427	-0.14% 
4	1391	-2.66% 
5	1396	-2.31% 
6	1401	-1.96% 
7	1362	-4.69% - skewed
Expect	14286.000
1	14399	+0.79% 
2	14239	-0.33% 
3	14084	-1.41% 
4	14231	-0.38% 
5	14235	-0.36% 
6	14407	+0.85% 
7	14407	+0.85% 
Expect	142858.000
1	142219	-0.45% 
2	143798	+0.66% 
3	142941	+0.06% 
4	143242	+0.27% 
5	142673	-0.13% 
6	142359	-0.35% 
7	142774	-0.06% 
END

my $xoar = qq:to/END/;
Expect	2.000
1	2	+0.00% 
2	2	+0.00% 
3	2	+0.00% 
4	2	+0.00% 
5	2	+0.00% 
6	2	+0.00% 
7	2	+0.00% 
Expect	15.000
1	14	-6.67% - skewed
2	16	+6.67% - skewed
3	10	-33.33% - skewed
4	17	+13.33% - skewed
5	13	-13.33% - skewed
6	13	-13.33% - skewed
7	22	+46.67% - skewed
Expect	143.000
1	151	+5.59% - skewed
2	157	+9.79% - skewed
3	126	-11.89% - skewed
4	149	+4.20% - skewed
5	135	-5.59% - skewed
6	133	-6.99% - skewed
7	150	+4.90% - skewed
Expect	1429.000
1	1524	+6.65% - skewed
2	1502	+5.11% - skewed
3	1425	-0.28% 
4	1391	-2.66% 
5	1397	-2.24% 
6	1401	-1.96% 
7	1363	-4.62% - skewed
Expect	14286.000
1	14398	+0.78% 
2	14242	-0.31% 
3	14086	-1.40% 
4	14228	-0.41% 
5	14235	-0.36% 
6	14405	+0.83% 
7	14408	+0.85% 
Expect	142858.000
1	142217	-0.45% 
2	143796	+0.66% 
3	142944	+0.06% 
4	143243	+0.27% 
5	142673	-0.13% 
6	142359	-0.35% 
7	142774	-0.06% 
END

my $jvm = qq:to/END/;
Expect	2.000
1	2	+0.00% 
2	3	+50.00% - skewed
3	1	-50.00% - skewed
4	2	+0.00% 
5	0	-100.00% - skewed
6	2	+0.00% 
7	4	+100.00% - skewed
Expect	15.000
1	13	-13.33% - skewed
2	19	+26.67% - skewed
3	23	+53.33% - skewed
4	18	+20.00% - skewed
5	12	-20.00% - skewed
6	11	-26.67% - skewed
7	9	-40.00% - skewed
Expect	143.000
1	155	+8.39% - skewed
2	136	-4.90% - skewed
3	146	+2.10% 
4	132	-7.69% - skewed
5	158	+10.49% - skewed
6	142	-0.70% 
7	132	-7.69% - skewed
Expect	1429.000
1	1443	+0.98% 
2	1463	+2.38% 
3	1389	-2.80% 
4	1390	-2.73% 
5	1498	+4.83% - skewed
6	1397	-2.24% 
7	1423	-0.42% 
Expect	14286.000
1	14332	+0.32% 
2	14263	-0.16% 
3	14364	+0.55% 
4	14346	+0.42% 
5	14215	-0.50% 
6	14247	-0.27% 
7	14235	-0.36% 
Expect	142858.000
1	142733	-0.09% 
2	142788	-0.05% 
3	142821	-0.03% 
4	142944	+0.06% 
5	142983	+0.09% 
6	142931	+0.05% 
7	142806	-0.04% 
END

use Test;
my $ref = $*VM ~~ /jvm/ ?? $jvm !! $moar;
is @res.join("\n"), chomp $ref;
